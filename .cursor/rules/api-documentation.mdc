---
globs: .ai/api/*
alwaysApply: false
---

Keep in mind that viberide has it own schema called viberide.
For development purposes authentication MUST have option to be disabled. it should be disabled when enviroment variable DEVENV is set to 'true'.

## Implemented Endpoints

### User Preferences

#### GET /api/user/preferences
Retrieves the current user's preferences.

**Authentication:** Required (bypassed in dev mode with DEVENV='true')

**Response:**
- `200 OK`: Returns `UserPreferencesResponse`
- `404 Not Found`: User has not set preferences yet
- `401 Unauthorized`: Not authenticated
- `500 Internal Server Error`: Server error

#### PUT /api/user/preferences
Creates or updates user preferences (upsert operation).

**Authentication:** Required (bypassed in dev mode with DEVENV='true')

**Request Body:** `UpdateUserPreferencesRequest`
```json
{
  "terrain": "paved" | "gravel" | "mixed",
  "road_type": "scenic" | "twisty" | "highway",
  "typical_duration_h": number (> 0, max 999.9),
  "typical_distance_km": number (> 0, max 999999.9)
}
```

**Response:**
- `201 Created`: Preferences created for first time
- `200 OK`: Preferences updated
- `400 Bad Request`: Validation failed (see error details)
- `401 Unauthorized`: Not authenticated
- `500 Internal Server Error`: Server error

### Notes

#### GET /api/notes
Retrieves paginated list of user's notes (excludes soft-deleted).

**Authentication:** Required (bypassed in dev mode with DEVENV='true')

**Query Parameters:**
- `page` (integer, optional, default: 1): Page number (â‰¥ 1)
- `limit` (integer, optional, default: 20, max: 100): Items per page
- `search` (string, optional, max: 250 chars): Full-text search query
- `archived` (boolean, optional, default: false): Include archived notes
- `sort` (enum, optional, default: "updated_at"): Sort field - "updated_at" | "created_at" | "title"
- `order` (enum, optional, default: "desc"): Sort order - "asc" | "desc"

**Response:**
- `200 OK`: Returns `NotesPaginatedResponse`
  ```json
  {
    "data": [
      {
        "note_id": "uuid",
        "title": "Weekend Mountain Ride",
        "note_text": "Planning a scenic ride through...",
        "trip_prefs": {
          "terrain": "paved",
          "road_type": "scenic"
        },
        "distance_km": null,
        "duration_h": null,
        "terrain": null,
        "road_type": null,
        "has_itinerary": true,
        "itinerary_count": 3,
        "created_at": "2024-12-06T10:00:00.000Z",
        "updated_at": "2024-12-06T10:00:00.000Z",
        "archived_at": null
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 45,
      "total_pages": 3
    }
  }
  ```
- `400 Bad Request`: Invalid query parameters
- `401 Unauthorized`: Not authenticated
- `404 Not Found`: Requested page exceeds total pages
- `500 Internal Server Error`: Server error

**Features:**
- Full-text search using PostgreSQL `search_vector`
- Multi-field sorting (updated_at, created_at, title)
- Itinerary count aggregation per note
- Archived/active filtering

#### POST /api/notes
Creates a new trip note.

**Authentication:** Required (bypassed in dev mode with DEVENV='true')

**Prerequisites:** User must have preferences set

**Request Body:** `CreateNoteRequest`
```json
{
  "title": "Weekend Mountain Ride",
  "note_text": "Planning a scenic ride through the mountains with stops at various viewpoints.",
  "trip_prefs": {
    "terrain": "paved",
    "road_type": "scenic",
    "duration_h": 4.0,
    "distance_km": 200.0
  }
}
```

**Validation:**
- `title`: String, 1-120 characters, trimmed, required, unique per user
- `note_text`: String, 10-1500 characters, trimmed, required
- `trip_prefs`: Object, optional, all fields optional:
  - `terrain`: "paved" | "gravel" | "mixed"
  - `road_type`: "scenic" | "twisty" | "highway"
  - `duration_h`: Number, > 0, max 999.9
  - `distance_km`: Number, > 0, max 999999.9

**Response:**
- `201 Created`: Note created successfully
  ```json
  {
    "note_id": "uuid",
    "user_id": "uuid",
    "title": "Weekend Mountain Ride",
    "note_text": "Planning a scenic ride through...",
    "trip_prefs": {
      "terrain": "paved",
      "road_type": "scenic",
      "duration_h": 4.0,
      "distance_km": 200.0
    },
    "ai_summary": null,
    "distance_km": null,
    "duration_h": null,
    "terrain": null,
    "road_type": null,
    "created_at": "2024-12-06T10:00:00.000Z",
    "updated_at": "2024-12-06T10:00:00.000Z",
    "archived_at": null
  }
  ```
- `400 Bad Request`: Validation error or malformed JSON
- `401 Unauthorized`: Not authenticated
- `403 Forbidden`: User preferences not set
- `409 Conflict`: Note with this title already exists
- `500 Internal Server Error`: Server error

#### GET /api/notes/:noteId
Retrieves a single note by ID.

**Authentication:** Required (bypassed in dev mode with DEVENV='true')

**Path Parameters:**
- `noteId` (UUID): ID of the note to retrieve

**Response:**
- `200 OK`: Returns `NoteResponse`
  ```json
  {
    "note_id": "uuid",
    "user_id": "uuid",
    "title": "Weekend Mountain Ride",
    "note_text": "Planning a scenic ride through...",
    "trip_prefs": {
      "terrain": "paved",
      "road_type": "scenic",
      "duration_h": 4.0,
      "distance_km": 200.0
    },
    "ai_summary": null,
    "distance_km": null,
    "duration_h": null,
    "terrain": null,
    "road_type": null,
    "created_at": "2024-12-07T10:00:00.000Z",
    "updated_at": "2024-12-07T10:00:00.000Z",
    "archived_at": null
  }
  ```
- `400 Bad Request`: Invalid noteId format (not a valid UUID)
- `401 Unauthorized`: Not authenticated
- `404 Not Found`: Note does not exist, is deleted, or belongs to different user
- `500 Internal Server Error`: Server error

**Notes:**
- Returns 404 for both non-existent and unauthorized access (security through obscurity)
- Excludes soft-deleted notes
- RLS enforces ownership

#### PUT /api/notes/:noteId
Updates an existing note.

**Authentication:** Required (bypassed in dev mode with DEVENV='true')

**Path Parameters:**
- `noteId` (UUID): ID of the note to update

**Request Body:** `UpdateNoteRequest`
```json
{
  "title": "Updated Weekend Ride",
  "note_text": "Updated description of the scenic ride through the mountains.",
  "trip_prefs": {
    "terrain": "mixed",
    "road_type": "twisty",
    "duration_h": 5.0,
    "distance_km": 250.0
  }
}
```

**Validation:** Same as POST /api/notes
- `title`: String, 1-120 characters, trimmed, required, unique per user
- `note_text`: String, 10-1500 characters, trimmed, required
- `trip_prefs`: Object, optional, all fields optional

**Response:**
- `200 OK`: Returns updated `NoteResponse`
- `400 Bad Request`: Invalid noteId format, malformed JSON, or validation errors
- `401 Unauthorized`: Not authenticated
- `404 Not Found`: Note does not exist, is deleted, or belongs to different user
- `409 Conflict`: Note with same title already exists for user
- `500 Internal Server Error`: Server error

**Notes:**
- Automatically updates `updated_at` timestamp
- Verifies note ownership before allowing update
- All fields in request body are required (full update, not partial)
- Title uniqueness constraint enforced

#### DELETE /api/notes/:noteId
Soft-deletes a note (sets deleted_at timestamp, cascades to itineraries).

**Authentication:** Required (bypassed in dev mode with DEVENV='true')

**Path Parameters:**
- `noteId` (UUID): ID of the note to delete

**Response:**
- `200 OK`: Successfully deleted, returns `DeleteNoteResponse`
  ```json
  {
    "success": true,
    "note_id": "uuid",
    "deleted_at": "2024-12-07T15:30:00.000Z"
  }
  ```
- `400 Bad Request`: Invalid noteId format (not a valid UUID)
- `401 Unauthorized`: Not authenticated
- `404 Not Found`: Note does not exist, already deleted, or belongs to different user
- `500 Internal Server Error`: Server error

**Notes:**
- Soft delete only (sets `deleted_at` timestamp, preserves data)
- Database trigger automatically cascades deletion to all associated itineraries
- Returns 404 for unauthorized access (not 403 for security)
- Attempting to delete already deleted note returns 404
- Preserves referential integrity and audit trail

### Itineraries

#### POST /api/notes/:noteId/itineraries
Starts AI-powered itinerary generation for an existing note. Creates a new itinerary row in "pending" state and returns minimal generation metadata. Generation runs asynchronously in the background.

**Authentication:** Required (bypassed in dev mode with DEVENV='true')

**Path Parameters:**
- `noteId` (UUID): ID of the note to generate itinerary for

**Request Body:** `GenerateItineraryRequest`
```json
{
  "request_id": "uuid" // Client-generated idempotency key
}
```

**Response:**
- `202 Accepted`: Generation successfully initiated, returns `GenerateItineraryResponse`
  ```json
  {
    "itinerary_id": "uuid",
    "note_id": "uuid",
    "version": 1,
    "status": "pending",
    "request_id": "uuid",
    "created_at": "ISO8601"
  }
  ```
- `400 Bad Request`: Invalid noteId format or validation failed
- `401 Unauthorized`: Not authenticated
- `403 Forbidden`: Note not owned by user OR user preferences missing
- `404 Not Found`: Note does not exist or has been deleted
- `409 Conflict`: Another generation already running for this user
  ```json
  {
    "error": "generation_in_progress",
    "message": "Another itinerary generation is already in progress",
    "details": {
      "active_request_id": "uuid"
    }
  }
  ```
- `429 Too Many Requests`: Monthly OpenAI spend cap exceeded
- `500 Internal Server Error`: Server error

**Notes:**
- Enforces single concurrent generation per user via database constraint
- Idempotent: duplicate `request_id` returns existing itinerary
- Requires user to have completed preferences before first generation
- Version number auto-increments for each note

#### GET /api/notes/:noteId/itineraries
Lists all itinerary versions for a specific note, ordered by version DESC (newest first).

**Authentication:** Required (bypassed in dev mode with DEVENV='true')

**Path Parameters:**
- `noteId` (UUID): ID of the note

**Query Parameters:**
- `status` (optional): Filter by status - "pending" | "running" | "completed" | "failed" | "cancelled"
- `limit` (optional, default: 20, max: 100): Maximum number of results

**Response:**
- `200 OK`: Success, returns `ItinerariesListResponse`
  ```json
  {
    "data": [
      {
        "itinerary_id": "uuid",
        "note_id": "uuid",
        "user_id": "uuid",
        "version": 3,
        "status": "completed",
        "route_geojson": {
          "type": "FeatureCollection",
          "properties": {
            "title": "Mountain Loop Adventure",
            "total_distance_km": 285.5,
            "total_duration_h": 5.5,
            "highlights": ["Mountain pass", "Scenic overlook"],
            "days": 2
          },
          "features": [...]
        },
        "title": "Mountain Loop Adventure",
        "total_distance_km": 285.5,
        "total_duration_h": 5.5,
        "request_id": "uuid",
        "created_at": "ISO8601",
        "updated_at": "ISO8601"
      }
    ]
  }
  ```
- `400 Bad Request`: Invalid noteId format or query parameters
- `401 Unauthorized`: Not authenticated
- `403 Forbidden`: Note owned by another user
- `404 Not Found`: Note does not exist or has been deleted
- `500 Internal Server Error`: Server error

**Notes:**
- Returns empty array if note has no itineraries
- Ordered by version DESC (newest first)
- Excludes soft-deleted itineraries
- Status filter is optional (omit to get all statuses)

#### GET /api/itineraries/:itineraryId
Retrieves a single itinerary by ID.

**Authentication:** Required (bypassed in dev mode with DEVENV='true')

**Path Parameters:**
- `itineraryId` (UUID): ID of the itinerary

**Response:**
- `200 OK`: Success, returns `ItineraryResponse`
  ```json
  {
    "itinerary_id": "uuid",
    "note_id": "uuid",
    "user_id": "uuid",
    "version": 2,
    "status": "completed",
    "route_geojson": {
      "type": "FeatureCollection",
      "properties": {
        "title": "Mountain Loop Adventure",
        "total_distance_km": 285.5,
        "total_duration_h": 5.5,
        "highlights": ["Mountain pass", "Scenic overlook"],
        "days": 2
      },
      "features": [
        {
          "type": "Feature",
          "geometry": {
            "type": "LineString",
            "coordinates": [[19.9450, 50.0647], [19.9496, 49.2992]]
          },
          "properties": {
            "name": "Segment 1",
            "description": "Scenic mountain route",
            "type": "route",
            "day": 1,
            "segment": 1,
            "distance_km": 120.5,
            "duration_h": 2.5
          }
        }
      ]
    },
    "title": "Mountain Loop Adventure",
    "total_distance_km": 285.5,
    "total_duration_h": 5.5,
    "request_id": "uuid",
    "created_at": "ISO8601",
    "updated_at": "ISO8601"
  }
  ```
- `400 Bad Request`: Invalid itineraryId format
- `401 Unauthorized`: Not authenticated
- `404 Not Found`: Itinerary does not exist, has been deleted, or belongs to another user
- `500 Internal Server Error`: Server error

**Notes:**
- RLS enforces ownership (returns 404 for unauthorized access)
- Excludes soft-deleted itineraries
- Returns complete itinerary details including GeoJSON route data
- `title`, `total_distance_km`, `total_duration_h` are derived fields for fast access

#### DELETE /api/itineraries/:itineraryId
Soft-deletes an itinerary by setting the `deleted_at` timestamp. Only allows deletion of itineraries with terminal status (completed, failed, or cancelled). Cannot delete pending or running itineraries.

**Authentication:** Required (bypassed in dev mode with DEVENV='true')

**Path Parameters:**
- `itineraryId` (UUID): ID of the itinerary to delete

**Response:**
- `200 OK`: Successfully deleted, returns `DeleteItineraryResponse`
  ```json
  {
    "success": true,
    "itinerary_id": "uuid",
    "deleted_at": "ISO8601"
  }
  ```
- `400 Bad Request`: Invalid itineraryId format OR itinerary has non-terminal status
  ```json
  {
    "error": "cannot_delete_nonterminal",
    "message": "Cannot delete itinerary with status 'pending'. Only completed, failed, or cancelled itineraries can be deleted."
  }
  ```
- `401 Unauthorized`: Not authenticated
- `404 Not Found`: Itinerary does not exist, has been deleted, or belongs to another user
- `500 Internal Server Error`: Server error

**Notes:**
- Soft-delete only (sets `deleted_at` timestamp, does not physically remove data)
- Business rule: Only terminal status itineraries can be deleted (completed, failed, cancelled)
- Attempting to delete pending/running itinerary returns 400 error
- Attempting to delete already deleted itinerary returns 404
- RLS enforces ownership (returns 404 for unauthorized access)

#### GET /api/itineraries/:itineraryId/status
Retrieves the generation status of an itinerary. Returns different response structure based on current status, optimized for polling.

**Authentication:** Required (bypassed in dev mode with DEVENV='true')

**Path Parameters:**
- `itineraryId` (UUID): ID of the itinerary

**Response:**
- `200 OK`: Success, returns `ItineraryStatusResponse` (union type based on status)

**Pending status:**
```json
{
  "itinerary_id": "uuid",
  "status": "pending"
}
```

**Running status:**
```json
{
  "itinerary_id": "uuid",
  "status": "running"
}
```

**Completed status (includes full GeoJSON):**
```json
{
  "itinerary_id": "uuid",
  "status": "completed",
  "route_geojson": {
    "type": "FeatureCollection",
    "properties": {
      "title": "Mountain Loop Adventure",
      "total_distance_km": 285.5,
      "total_duration_h": 5.5,
      "highlights": ["Mountain pass", "Scenic overlook"],
      "days": 2
    },
    "features": [...]
  }
}
```

**Failed status:**
```json
{
  "itinerary_id": "uuid",
  "status": "failed"
}
```

**Cancelled status:**
```json
{
  "itinerary_id": "uuid",
  "status": "cancelled",
  "cancelled_at": "ISO8601"
}
```

- `400 Bad Request`: Invalid itineraryId format
- `401 Unauthorized`: Not authenticated
- `404 Not Found`: Itinerary does not exist, has been deleted, or belongs to another user
- `500 Internal Server Error`: Server error

**Notes:**
- Optimized for polling: returns minimal fields for pending/running, full data when completed
- Different response structure based on status (discriminated union type)
- Use this endpoint to poll generation progress instead of fetching full itinerary
- RLS enforces ownership (returns 404 for unauthorized access)
- Excludes soft-deleted itineraries

#### POST /api/itineraries/:itineraryId/cancel
Cancels a pending or running itinerary generation. Only allows cancellation of itineraries with pending or running status.

**Authentication:** Required (bypassed in dev mode with DEVENV='true')

**Path Parameters:**
- `itineraryId` (UUID): ID of the itinerary to cancel

**Request Body:** None

**Response:**
- `200 OK`: Successfully cancelled, returns `CancelItineraryResponse`
  ```json
  {
    "itinerary_id": "uuid",
    "status": "cancelled",
    "cancelled_at": "ISO8601"
  }
  ```
- `400 Bad Request`: Invalid itineraryId format OR itinerary has terminal status
  ```json
  {
    "error": "cannot_cancel",
    "message": "Cannot cancel itinerary with status 'completed'. Only pending or running itineraries can be cancelled."
  }
  ```
- `401 Unauthorized`: Not authenticated
- `404 Not Found`: Itinerary does not exist, has been deleted, or belongs to another user
- `500 Internal Server Error`: Server error

**Notes:**
- Business rule: Only pending or running itineraries can be cancelled
- Attempting to cancel completed/failed/cancelled itinerary returns 400 error
- Sets status to 'cancelled' and updates timestamp
- Attempting to cancel already cancelled itinerary returns 400 (not idempotent)
- RLS enforces ownership (returns 404 for unauthorized access)
- Background worker should detect cancellation and stop processing

#### GET /api/itineraries/:itineraryId/download
Downloads itinerary as GPX 1.1, KML 2.2, or GeoJSON file. Requires safety disclaimer acknowledgment.

**Authentication:** Required (bypassed in dev mode with DEVENV='true')

**Path Parameters:**
- `itineraryId` (UUID): ID of the itinerary

**Query Parameters:**
- `format` (optional, default: "gpx"): Download format - "gpx" | "kml" | "geojson"
- `acknowledged` (required, must be "true"): User must acknowledge GPS accuracy disclaimer

**Response:**
- `200 OK`: Success, returns file in requested format
  - **GPX format:**
    - `Content-Type: application/gpx+xml`
    - `Content-Disposition: attachment; filename="route-{title}-{id}.gpx"`
    - Body: GPX 1.1 XML file with waypoints and routes
  - **KML format:**
    - `Content-Type: application/vnd.google-earth.kml+xml`
    - `Content-Disposition: attachment; filename="route-{title}-{id}.kml"`
    - Body: KML 2.2 XML file compatible with Google Earth
  - **GeoJSON format:**
    - `Content-Type: application/geo+json`
    - `Content-Disposition: attachment; filename="route-{title}-{id}.geojson"`
    - Body: Pretty-printed GeoJSON FeatureCollection
- `400 Bad Request`: Invalid parameters or missing acknowledgment
  ```json
  {
    "error": "acknowledgment_required",
    "message": "You must acknowledge the GPS accuracy disclaimer by setting acknowledged=true"
  }
  ```
- `401 Unauthorized`: Not authenticated
- `404 Not Found`: Itinerary does not exist, has been deleted, or belongs to another user
- `422 Unprocessable Entity`: Itinerary is not completed OR data is incomplete
  ```json
  {
    "error": "itinerary_not_completed",
    "message": "Cannot download GPX for itinerary with status 'pending'. Only completed itineraries can be downloaded."
  }
  ```
- `500 Internal Server Error`: Conversion error (GPX/KML generation failed)
  ```json
  {
    "error": "conversion_error",
    "message": "Failed to convert to GPX: {error details}"
  }
  ```

**Notes:**
- Business rule: Only completed itineraries can be downloaded
- Requires explicit acknowledgment of GPS accuracy disclaimer via query parameter
- Files generated on-the-fly from GeoJSON (not stored)
- **GPX conversion** includes:
  - Point features as waypoints
  - LineString features as route points
  - Metadata from GeoJSON properties
  - Compatible with Garmin, TomTom, and most GPS devices
- **KML conversion** includes:
  - Point features as placemarks with custom icons
  - LineString features as styled routes
  - Organized in folders (Waypoints, Route)
  - Compatible with Google Earth, Google Maps
- **GeoJSON format**:
  - Raw FeatureCollection with all properties
  - Compatible with web mapping libraries (Leaflet, Mapbox)
- Filename sanitized from itinerary title
- GeoJSON is the source of truth; GPX/KML converted on-demand
- RLS enforces ownership (returns 404 for unauthorized access)
- Response cached for 1 hour (private cache)

#### GET /api/itineraries/:itineraryId/mapy
Generates a Mapy.cz URL with route parameters for viewing the itinerary in Mapy.cz web interface. Returns instant response (no file generation).

**Authentication:** Required (bypassed in dev mode with DEVENV='true')

**Path Parameters:**
- `itineraryId` (UUID): ID of the itinerary

**Query Parameters:**
- `acknowledged` (required, must be "true"): User must acknowledge GPS accuracy disclaimer

**Response:**
- `200 OK`: Success, returns `MapyLinkResponse`
  ```json
  {
    "url": "https://mapy.cz/?route=bike|49.420800,20.941900,Start|49.395200,20.414200,End&lang=en"
  }
  ```
- `400 Bad Request`: Invalid parameters or missing acknowledgment
  ```json
  {
    "error": "acknowledgment_required",
    "message": "You must acknowledge the GPS accuracy disclaimer by setting acknowledged=true"
  }
  ```
- `401 Unauthorized`: Not authenticated
- `404 Not Found`: Itinerary does not exist, has been deleted, or belongs to another user
- `422 Unprocessable Entity`: Itinerary not completed OR route has too many points
  ```json
  {
    "error": "itinerary_not_completed",
    "message": "Cannot generate Mapy.cz link for itinerary with status 'pending'. Only completed itineraries can be shared."
  }
  ```
  ```json
  {
    "error": "too_many_points",
    "message": "Route has too many points for Mapy.cz (max 15). Please try downloading GPX instead."
  }
  ```
- `500 Internal Server Error`: Link generation failed
  ```json
  {
    "error": "link_generation_error",
    "message": "Failed to generate Mapy.cz link: {error details}"
  }
  ```

**Notes:**
- Business rule: Only completed itineraries can be shared
- Requires explicit acknowledgment of GPS accuracy disclaimer (same as download)
- Pure synchronous computation (< 10ms response time)
- URL uses Mapy.cz query-string routing API (no GPX upload needed)
- **Route format**: `route=<transport>|lat,lon,name|lat,lon,name|...`
- Transport mode: "bike" (suitable for motorcycles)
- Mapy.cz limit: Maximum 15 route points
- **Point sampling**: If route has >15 points, algorithm samples evenly (first + last + middle points)
- Coordinates rounded to 6 decimal places (~0.1m precision)
- Point names URL-encoded
- Language set to English (`lang=en`)
- RLS enforces ownership (returns 404 for unauthorized access)
- Response cached for 1 hour (private cache)
- Alternative to GPX download for quick route preview in Mapy.cz

### Analytics (Internal/Admin)

#### GET /api/analytics/users/stats
Retrieves aggregated user statistics for administrative dashboards.

**Authentication:** Service role required (bypassed in dev mode with DEVENV='true')

**Query Parameters:**
- `from` (ISO 8601 date, optional): Statistics start date (inclusive)
- `to` (ISO 8601 date, optional): Statistics end date (inclusive, defaults to now)

**Response:**
- `200 OK`: Returns `UserStatsResponse`
  ```json
  {
    "total_users": 100,
    "users_with_completed_profiles": 75,
    "profile_completion_rate": 0.75,
    "active_users_30d": 50,
    "new_users_30d": 10
  }
  ```
- `400 Bad Request`: Invalid query parameters (invalid date format or from > to)
- `401 Unauthorized`: Not authenticated
- `403 Forbidden`: Not service role (production only)
- `500 Internal Server Error`: Server error

**Notes:**
- Internal endpoint for admin dashboards only
- Service role authentication required in production
- Date range filters apply to `new_users_30d` calculation
- Active users defined as users with `last_sign_in_at` within last 30 days
- Profile completion rate = users_with_completed_profiles / total_users

#### GET /api/analytics/generations/stats
Retrieves aggregated itinerary generation statistics for administrative dashboards.

**Authentication:** Service role required (bypassed in dev mode with DEVENV='true')

**Query Parameters:**
- `from` (ISO 8601 date, optional): Statistics start date (inclusive)
- `to` (ISO 8601 date, optional): Statistics end date (inclusive, defaults to now)

**Response:**
- `200 OK`: Returns `GenerationStatsResponse`
  ```json
  {
    "total_generations": 100,
    "completed_generations": 80,
    "failed_generations": 15,
    "cancelled_generations": 5,
    "failure_rate": 0.15,
    "avg_generation_time_seconds": 45.5,
    "p95_generation_time_seconds": 120.0,
    "generations_per_user": {
      "mean": 2.5,
      "median": 2.0,
      "users_with_3_plus": 15
    },
    "estimated_cost_usd": 0.8
  }
  ```
- `400 Bad Request`: Invalid query parameters (invalid date format or from > to)
- `401 Unauthorized`: Not authenticated
- `403 Forbidden`: Not service role (production only)
- `500 Internal Server Error`: Server error

**Notes:**
- Internal endpoint for admin dashboards only
- Service role authentication required in production
- Date range filters apply to all generation counts and statistics
- Generation time calculated as `updated_at - created_at` for completed itineraries
- P95 = 95th percentile of generation times
- Failure rate = failed_generations / total_generations
- Cost estimation: $0.01 per completed generation (placeholder for MVP)
- Per-user statistics include mean, median, and count of users with 3+ generations

### Health Check

#### GET /api/health
Public health check endpoint for uptime monitoring.

**Authentication:** None (public endpoint)

**Response:**
- `200 OK`: Returns `HealthCheckResponse` (always returns 200 unless catastrophic failure)
  ```json
  {
    "status": "healthy",
    "database": "connected",
    "auth": "operational",
    "timestamp": "2025-12-07T16:00:00.000Z"
  }
  ```
- `500 Internal Server Error`: Catastrophic failure (unable to construct response)

**Status Values:**
- `status`: "healthy" | "degraded" | "unhealthy"
- `database`: "connected" | "disconnected" | "error"
- `auth`: "operational" | "degraded" | "down"

**Notes:**
- Public endpoint designed for monitoring tools (Fly.io, Kubernetes, external monitors)
- Performs concurrent health checks for Database and Auth subsystems
- Returns 200 OK even when degraded to distinguish API layer from subsystem failures
- 50ms timeout per subsystem check
- Target latency: <100ms p95
- No sensitive data or stack traces in responses
- Structured logging for all scenarios
